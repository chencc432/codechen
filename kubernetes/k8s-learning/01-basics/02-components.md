# ğŸ”© Kubernetes æ ¸å¿ƒç»„ä»¶è¯¦è§£

## ç»„ä»¶äº¤äº’æ€»è§ˆ

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    User      â”‚
                    â”‚  (kubectl)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTPS
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Control Plane                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    API Server                            â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚   â”‚ è®¤è¯      â”‚  â”‚  æˆæƒ      â”‚  â”‚  å‡†å…¥æ§åˆ¶         â”‚    â”‚ â”‚
â”‚  â”‚   â”‚ (AuthN)  â”‚â”€>â”‚  (AuthZ)  â”‚â”€>â”‚ (Admission)      â”‚    â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â”‚            â”‚            â”‚            â”‚          â”‚
â”‚            â–¼            â–¼            â–¼            â–¼          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    etcd    â”‚ â”‚ Scheduler  â”‚ â”‚ Controller â”‚ â”‚  Cloud    â”‚ â”‚
â”‚  â”‚            â”‚ â”‚            â”‚ â”‚  Manager   â”‚ â”‚ Controllerâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚               â”‚               â”‚
           â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Node 1   â”‚  â”‚   Node 2   â”‚  â”‚   Node 3   â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚kubeletâ”‚ â”‚  â”‚  â”‚kubeletâ”‚ â”‚  â”‚  â”‚kubeletâ”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚proxy â”‚  â”‚  â”‚  â”‚proxy â”‚  â”‚  â”‚  â”‚proxy â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 1. API Server æ·±å…¥è¯¦è§£

### 1.1 æ ¸å¿ƒåŠŸèƒ½

API Server æ˜¯ Kubernetes çš„"å‰é—¨"ï¼Œæ‰€æœ‰æ“ä½œéƒ½å¿…é¡»ç»è¿‡å®ƒã€‚

```
è¯·æ±‚å¤„ç†æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API Server                               â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   è®¤è¯    â”‚â”€â”€â”€>â”‚   æˆæƒ    â”‚â”€â”€â”€>â”‚       å‡†å…¥æ§åˆ¶           â”‚ â”‚
â”‚  â”‚ (AuthN)  â”‚    â”‚ (AuthZ)  â”‚    â”‚  Mutating + Validating   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚       â”‚              â”‚                       â”‚                  â”‚
â”‚       â–¼              â–¼                       â–¼                  â”‚
â”‚   è°åœ¨è¯·æ±‚ï¼Ÿ     æ˜¯å¦æœ‰æƒé™ï¼Ÿ         æ˜¯å¦ç¬¦åˆç­–ç•¥ï¼Ÿ              â”‚
â”‚   (èº«ä»½éªŒè¯)    (RBACæ£€æŸ¥)         (ä¿®æ”¹/éªŒè¯èµ„æº)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 è®¤è¯æ–¹å¼

```yaml
# å¸¸è§è®¤è¯æ–¹å¼
è®¤è¯æ–¹å¼:
  - X509 å®¢æˆ·ç«¯è¯ä¹¦     # æœ€å¸¸ç”¨ï¼Œkubeconfig é»˜è®¤æ–¹å¼
  - Bearer Token       # ServiceAccount ä½¿ç”¨
  - Bootstrap Token    # èŠ‚ç‚¹åŠ å…¥é›†ç¾¤
  - OpenID Connect     # é›†æˆä¼ä¸šè®¤è¯
  - Webhook Token      # å¤–éƒ¨è®¤è¯æœåŠ¡
```

### 1.3 API ç‰ˆæœ¬æ¼”è¿›

```
API ç‰ˆæœ¬æˆç†Ÿåº¦ï¼š
alpha (v1alpha1) â†’ beta (v1beta1) â†’ stable (v1)
     â”‚                  â”‚                â”‚
     â–¼                  â–¼                â–¼
   å®éªŒæ€§           å³å°†ç¨³å®š           ç”Ÿäº§å¯ç”¨
   å¯èƒ½ç§»é™¤         é»˜è®¤å¯ç”¨           é•¿æœŸæ”¯æŒ
```

### 1.4 æŸ¥çœ‹ API Server

```bash
# æŸ¥çœ‹ API Server åœ°å€
kubectl cluster-info

# ç›´æ¥è®¿é—® APIï¼ˆéœ€è¦è®¤è¯ï¼‰
kubectl proxy &  # å¯åŠ¨ä»£ç†
curl http://localhost:8001/api/v1/namespaces

# æŸ¥çœ‹ API Server é…ç½®ï¼ˆå¦‚æœèƒ½è®¿é—® master èŠ‚ç‚¹ï¼‰
cat /etc/kubernetes/manifests/kube-apiserver.yaml
```

## 2. etcd æ·±å…¥è¯¦è§£

### 2.1 ä»€ä¹ˆæ˜¯ etcdï¼Ÿ

etcd æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼é”®å€¼æ•°æ®åº“ï¼ŒKubernetes ç”¨å®ƒå­˜å‚¨æ‰€æœ‰é›†ç¾¤æ•°æ®ã€‚

```
etcd å­˜å‚¨ç»“æ„ï¼š
/registry
â”œâ”€â”€ /pods
â”‚   â”œâ”€â”€ /default/nginx-pod
â”‚   â””â”€â”€ /kube-system/coredns-xxx
â”œâ”€â”€ /services
â”‚   â””â”€â”€ /default/kubernetes
â”œâ”€â”€ /deployments
â”‚   â””â”€â”€ /default/nginx-deployment
â”œâ”€â”€ /secrets
â”‚   â””â”€â”€ /default/my-secret
â””â”€â”€ /configmaps
    â””â”€â”€ /default/my-config
```

### 2.2 etcd æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| å¼ºä¸€è‡´æ€§ | ä½¿ç”¨ Raft åè®®ä¿è¯æ•°æ®ä¸€è‡´ |
| é«˜å¯ç”¨ | æ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼ˆå»ºè®® 3/5/7 èŠ‚ç‚¹ï¼‰ |
| Watch æœºåˆ¶ | æ”¯æŒç›‘å¬æ•°æ®å˜åŒ– |
| MVCC | å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ |

### 2.3 etcd æ“ä½œç¤ºä¾‹ï¼ˆé«˜çº§ï¼‰

```bash
# åœ¨ etcd å®¹å™¨ä¸­æ‰§è¡Œï¼ˆéœ€è¦è®¿é—® master èŠ‚ç‚¹ï¼‰
# åˆ—å‡ºæ‰€æœ‰ key
etcdctl get / --prefix --keys-only

# æŸ¥çœ‹æŸä¸ªèµ„æº
etcdctl get /registry/pods/default/nginx --print-value-only

# æŸ¥çœ‹é›†ç¾¤æˆå‘˜
etcdctl member list

# æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶æ€
etcdctl endpoint health
```

## 3. Scheduler æ·±å…¥è¯¦è§£

### 3.1 è°ƒåº¦æµç¨‹

```
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   å¾…è°ƒåº¦çš„ Pod    â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚       é¢„é€‰ï¼ˆPredicatesï¼‰        â”‚
              â”‚    è¿‡æ»¤ä¸æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚       ä¼˜é€‰ï¼ˆPrioritiesï¼‰        â”‚
              â”‚    å¯¹å‰©ä½™èŠ‚ç‚¹æ‰“åˆ†æ’åº           â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚          é€‰æ‹©èŠ‚ç‚¹              â”‚
              â”‚    é€‰æ‹©å¾—åˆ†æœ€é«˜çš„èŠ‚ç‚¹           â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚          ç»‘å®š Pod             â”‚
              â”‚    æ›´æ–° Pod çš„ nodeName        â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 é¢„é€‰ï¼ˆFilteringï¼‰ç­–ç•¥

```yaml
å¸¸è§é¢„é€‰ç­–ç•¥:
  PodFitsResources:    # èŠ‚ç‚¹èµ„æºæ˜¯å¦æ»¡è¶³ Pod éœ€æ±‚
  PodFitsHost:         # èŠ‚ç‚¹åæ˜¯å¦åŒ¹é… nodeName
  PodFitsHostPorts:    # ç«¯å£æ˜¯å¦å†²çª
  PodMatchNodeSelector: # æ˜¯å¦åŒ¹é… nodeSelector
  NoDiskConflict:      # å­˜å‚¨å·æ˜¯å¦å†²çª
  CheckNodeCondition:  # èŠ‚ç‚¹æ˜¯å¦å¤„äº Ready çŠ¶æ€
  PodToleratesNodeTaints: # æ˜¯å¦å®¹å¿èŠ‚ç‚¹æ±¡ç‚¹
```

### 3.3 ä¼˜é€‰ï¼ˆScoringï¼‰ç­–ç•¥

```yaml
å¸¸è§ä¼˜é€‰ç­–ç•¥:
  LeastRequestedPriority:  # èµ„æºä½¿ç”¨ç‡æœ€ä½ä¼˜å…ˆ
  BalancedResourceAllocation: # èµ„æºå‡è¡¡åˆ†é…
  ImageLocalityPriority:   # é•œåƒå·²å­˜åœ¨ä¼˜å…ˆ
  NodeAffinityPriority:    # èŠ‚ç‚¹äº²å’Œæ€§
  InterPodAffinityPriority: # Pod äº²å’Œæ€§
```

### 3.4 è°ƒåº¦ç¤ºä¾‹

```yaml
# pod-scheduling-example.yaml
apiVersion: v1
kind: Pod
metadata:
  name: scheduling-demo
spec:
  # æŒ‡å®šèŠ‚ç‚¹é€‰æ‹©å™¨
  nodeSelector:
    disktype: ssd
  
  # èµ„æºè¯·æ±‚ï¼ˆå½±å“è°ƒåº¦ï¼‰
  containers:
  - name: nginx
    image: nginx
    resources:
      requests:
        cpu: "500m"
        memory: "256Mi"
      limits:
        cpu: "1"
        memory: "512Mi"
  
  # å®¹å¿åº¦
  tolerations:
  - key: "key1"
    operator: "Equal"
    value: "value1"
    effect: "NoSchedule"
```

## 4. Controller Manager æ·±å…¥è¯¦è§£

### 4.1 æ§åˆ¶å™¨æ¨¡å¼

Controller çš„æ ¸å¿ƒæ˜¯**æ§åˆ¶å¾ªç¯**ï¼ˆControl Loopï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Control Loop                            â”‚
â”‚                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ è§‚å¯Ÿå½“å‰  â”‚â”€â”€â”€â”€>â”‚  å¯¹æ¯”å·®å¼‚  â”‚â”€â”€â”€â”€>â”‚  æ‰§è¡Œè°ƒè°æ“ä½œ     â”‚  â”‚
â”‚   â”‚   çŠ¶æ€    â”‚     â”‚          â”‚     â”‚  (Reconcile)     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â–²                                      â”‚            â”‚
â”‚        â”‚                                      â”‚            â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                              â”‚
â”‚              æœŸæœ›çŠ¶æ€ vs å½“å‰çŠ¶æ€ â†’ é‡‡å–è¡ŒåŠ¨                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å¸¸è§æ§åˆ¶å™¨è¯¦è§£

#### Deployment Controller

```
æœŸæœ›: 3 ä¸ªå‰¯æœ¬
å½“å‰: 2 ä¸ª Pod è¿è¡Œä¸­

Deployment Controller åŠ¨ä½œ:
â†’ å‘ç°å·®å¼‚ï¼šç¼ºå°‘ 1 ä¸ªå‰¯æœ¬
â†’ åˆ›å»ºæ–°çš„ Pod
â†’ æŒç»­ç›‘æ§ç›´åˆ°è¾¾åˆ°æœŸæœ›çŠ¶æ€
```

#### Node Controller

```
èŒè´£:
1. ç›‘æ§èŠ‚ç‚¹å¥åº·çŠ¶æ€
2. èŠ‚ç‚¹å¤±è”åæ ‡è®°ä¸º NotReady
3. è¶…æ—¶åé©±é€èŠ‚ç‚¹ä¸Šçš„ Pod

æ—¶é—´çº¿:
0s:    èŠ‚ç‚¹å¤±è”
40s:   æ ‡è®° Unknown
5m:    å¼€å§‹é©±é€ Pod
```

#### ReplicaSet Controller

```
ç›‘å¬: ReplicaSet èµ„æºå˜åŒ–
åŠ¨ä½œ:
  - å‰¯æœ¬ä¸è¶³ â†’ åˆ›å»º Pod
  - å‰¯æœ¬è¿‡å¤š â†’ åˆ é™¤ Pod
  - æ›´æ–°æ ‡ç­¾é€‰æ‹©å™¨ â†’ è°ƒæ•´ Pod
```

### 4.3 æŸ¥çœ‹æ§åˆ¶å™¨çŠ¶æ€

```bash
# æŸ¥çœ‹ controller-manager pod
kubectl get pod -n kube-system | grep controller-manager

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -n kube-system kube-controller-manager-<node-name>

# æŸ¥çœ‹æ§åˆ¶å™¨é…ç½®
kubectl describe pod -n kube-system kube-controller-manager-<node-name>
```

## 5. kubelet æ·±å…¥è¯¦è§£

### 5.1 kubelet èŒè´£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       kubelet                          â”‚
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚               ä¸»è¦èŒè´£                            â”‚ â”‚
â”‚  â”‚                                                   â”‚ â”‚
â”‚  â”‚  1. å‘ API Server æ³¨å†ŒèŠ‚ç‚¹                        â”‚ â”‚
â”‚  â”‚  2. ç›‘å¬ API Server åˆ†é…çš„ Pod                    â”‚ â”‚
â”‚  â”‚  3. è°ƒç”¨å®¹å™¨è¿è¡Œæ—¶åˆ›å»º/ç®¡ç†å®¹å™¨                    â”‚ â”‚
â”‚  â”‚  4. æ‰§è¡Œå¥åº·æ£€æŸ¥                                  â”‚ â”‚
â”‚  â”‚  5. ä¸ŠæŠ¥èŠ‚ç‚¹å’Œ Pod çŠ¶æ€                           â”‚ â”‚
â”‚  â”‚  6. ç®¡ç†å·çš„æŒ‚è½½/å¸è½½                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   CRI    â”‚  â”‚   CNI    â”‚  â”‚      CSI         â”‚   â”‚
â”‚  â”‚ å®¹å™¨è¿è¡Œæ—¶â”‚  â”‚ ç½‘ç»œæ’ä»¶  â”‚  â”‚    å­˜å‚¨æ’ä»¶       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 kubelet ä¸ CRI

```
                kubelet
                   â”‚
                   â”‚ gRPC
                   â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚     CRI     â”‚ (Container Runtime Interface)
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼          â–¼          â–¼
   containerd    CRI-O    Docker+cri-dockerd
```

### 5.3 å¥åº·æ£€æŸ¥ç±»å‹

```yaml
# Pod å¥åº·æ£€æŸ¥ç¤ºä¾‹
apiVersion: v1
kind: Pod
metadata:
  name: health-check-demo
spec:
  containers:
  - name: app
    image: nginx
    
    # å­˜æ´»æ¢é’ˆ - æ£€æµ‹å®¹å™¨æ˜¯å¦å­˜æ´»
    livenessProbe:
      httpGet:
        path: /healthz
        port: 8080
      initialDelaySeconds: 10
      periodSeconds: 10
    
    # å°±ç»ªæ¢é’ˆ - æ£€æµ‹å®¹å™¨æ˜¯å¦å‡†å¤‡å¥½æ¥æ”¶æµé‡
    readinessProbe:
      httpGet:
        path: /ready
        port: 8080
      initialDelaySeconds: 5
      periodSeconds: 5
    
    # å¯åŠ¨æ¢é’ˆ - æ£€æµ‹å®¹å™¨æ˜¯å¦å¯åŠ¨å®Œæˆ
    startupProbe:
      httpGet:
        path: /startup
        port: 8080
      failureThreshold: 30
      periodSeconds: 10
```

## 6. kube-proxy æ·±å…¥è¯¦è§£

### 6.1 Service å®ç°åŸç†

```
             Client
                â”‚
                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Service IP   â”‚  10.96.0.100:80
        â”‚   (è™šæ‹Ÿ IP)     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  kube-proxy   â”‚  iptables/IPVS è§„åˆ™
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
        â–¼               â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Pod A  â”‚    â”‚  Pod B  â”‚
   â”‚10.1.1.10â”‚    â”‚10.1.2.20â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 å·¥ä½œæ¨¡å¼å¯¹æ¯”

| æ¨¡å¼ | åŸç† | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| iptables | ä½¿ç”¨ iptables è§„åˆ™è½¬å‘ | ä¸­ç­‰ | é»˜è®¤æ¨¡å¼ |
| IPVS | ä½¿ç”¨ Linux IPVS æ¨¡å— | é«˜ | å¤§è§„æ¨¡é›†ç¾¤ |
| userspace | ç”¨æˆ·ç©ºé—´ä»£ç† | ä½ | å·²å¼ƒç”¨ |

### 6.3 iptables æ¨¡å¼ç¤ºä¾‹

```bash
# æŸ¥çœ‹ kube-proxy åˆ›å»ºçš„ iptables è§„åˆ™
sudo iptables -t nat -L -n | grep -i kubernetes

# è§„åˆ™é“¾ç¤ºä¾‹
KUBE-SERVICES       # å…¥å£é“¾ï¼ŒåŒ¹é… Service ClusterIP
KUBE-SVC-XXX        # å•ä¸ª Service çš„è§„åˆ™
KUBE-SEP-XXX        # å•ä¸ª Endpointï¼ˆPodï¼‰çš„è§„åˆ™
```

## 7. ç»„ä»¶é€šä¿¡å®‰å…¨

### 7.1 è¯ä¹¦ä½“ç³»

```
                     Root CA
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼               â–¼               â–¼
   API Server CA    etcd CA       Front Proxy CA
        â”‚               â”‚               â”‚
        â–¼               â–¼               â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ API Server  â”‚ â”‚  etcd   â”‚  â”‚ Aggregation API â”‚
  â”‚ kubelet     â”‚ â”‚ Client  â”‚  â”‚    Server       â”‚
  â”‚ Controller  â”‚ â”‚ Peer    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚ Scheduler   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æŸ¥çœ‹è¯ä¹¦

```bash
# æŸ¥çœ‹ kubeconfig ä¸­çš„è¯ä¹¦
kubectl config view

# æŸ¥çœ‹è¯ä¹¦è¯¦æƒ…ï¼ˆåœ¨ master èŠ‚ç‚¹ï¼‰
openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout

# æ£€æŸ¥è¯ä¹¦è¿‡æœŸæ—¶é—´
kubeadm certs check-expiration
```

## å®è·µç»ƒä¹ 

### ç»ƒä¹  1ï¼šæ¢ç´¢ç»„ä»¶ Pod

```bash
# æŸ¥çœ‹æ‰€æœ‰ç³»ç»Ÿç»„ä»¶
kubectl get pods -n kube-system -o wide

# æŸ¥çœ‹ç»„ä»¶è¯¦æƒ…
kubectl describe pod -n kube-system kube-apiserver-<node>
kubectl describe pod -n kube-system etcd-<node>

# æŸ¥çœ‹ç»„ä»¶æ—¥å¿—
kubectl logs -n kube-system kube-scheduler-<node>
```

### ç»ƒä¹  2ï¼šç›‘æ§è°ƒåº¦è¿‡ç¨‹

```bash
# åˆ›å»ºä¸€ä¸ª Pod
kubectl run test-pod --image=nginx

# æŸ¥çœ‹è°ƒåº¦äº‹ä»¶
kubectl describe pod test-pod

# æŸ¥çœ‹è°ƒåº¦å™¨æ—¥å¿—
kubectl logs -n kube-system kube-scheduler-<node> | grep test-pod
```

### ç»ƒä¹  3ï¼šç†è§£æ§åˆ¶å™¨

```bash
# åˆ›å»º Deployment
kubectl create deployment nginx --image=nginx --replicas=3

# è§‚å¯Ÿ ReplicaSet
kubectl get rs -w

# åˆ é™¤ä¸€ä¸ª Podï¼Œè§‚å¯Ÿè‡ªåŠ¨æ¢å¤
kubectl delete pod <pod-name>
kubectl get pods -w
```

## å…³é”®è¦ç‚¹

1. **API Server æ˜¯ä¸­å¿ƒ**ï¼šæ‰€æœ‰ç»„ä»¶éƒ½é€šè¿‡å®ƒé€šä¿¡
2. **etcd æ˜¯å”¯ä¸€æ•°æ®æº**ï¼šåªæœ‰ API Server å¯ä»¥ç›´æ¥è®¿é—®
3. **æ§åˆ¶å™¨æ¨¡å¼**ï¼šå¯¹æ¯”æœŸæœ›çŠ¶æ€å’Œå½“å‰çŠ¶æ€ï¼Œè‡ªåŠ¨è°ƒè°
4. **å£°æ˜å¼ API**ï¼šå‘Šè¯‰ K8s è¦ä»€ä¹ˆï¼Œè€Œä¸æ˜¯æ€ä¹ˆåš
5. **æ¾è€¦åˆè®¾è®¡**ï¼šç»„ä»¶å¯ä»¥ç‹¬ç«‹å‡çº§å’Œæ›¿æ¢

## ä¸‹ä¸€æ­¥

- [æ ¸å¿ƒæ¦‚å¿µä¸æœ¯è¯­](./03-concepts.md) - ç†è§£ K8s çš„æ ¸å¿ƒæ¦‚å¿µ



